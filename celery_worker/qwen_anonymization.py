#TODO: Add text preprocessing after mappings for case normalization

#TODO: Попробовать промпты Алекся для создания карты + саммари

#TODO: Go through multiple rounds of prompts to create the mappings. Round 1: prompt with existing mappings and update it if new entities have been identified, Round 2: anonymize text algorithmically, Round 3: depending on the end result - create another mapping or compare the already existing mapping to what the llm has produced
import os
import requests
from tokenCounter import count_tokens
import re
from pydantic import BaseModel
import json

OLLAMA_URL = os.getenv("OLLAMA_HOST", "http://localhost:11434")

def remove_tagged_text(text:str, tag:str) -> str:
    """
    Remove parts of text enclosed in a specific tag.
    """
    pattern = re.compile(r"<" + tag + r">.*?</" + tag + r">", re.DOTALL)
    return re.sub(pattern, "", text)

def get_anonymization_mapping(text: str, model_name: str) -> dict[str, str] | str:
    """
    Generates anonymization mapping from the provided text using LLM.
    Returns a dict with mappings or an error string.
    """
    prompt = f"""ЗАДАЧА: Анализ текста и выявление чувствительных данных с созданием карты замен

ИНСТРУКЦИИ:
Проанализируй предоставленный текст и выяви ВСЕ именованные сущности и чувствительную информацию, которая может содержать:
- Персональные данные (ПДн)
- Корпоративную конфиденциальную информацию
- Коммерческую тайну
- Технические данные

КАТЕГОРИИ ДЛЯ ВЫЯВЛЕНИЯ:

1. ПЕРСОНАЛЬНЫЕ ДАННЫЕ:
   - Имена и фамилии людей
   - Отчества и полные ФИО
   - Должности и звания
   - Email адреса
   - Номера телефонов (мобильные и городские)
   - Адреса (почтовые, домашние, рабочие)
   - Паспортные данные, ИНН, СНИЛС
   - Даты рождения
   - Банковские реквизиты
   - IP-адреса и MAC-адреса

2. ГЕОГРАФИЧЕСКИЕ ДАННЫЕ:
   - Названия городов и населенных пунктов
   - Названия стран и регионов
   - Названия улиц, районов
   - Почтовые индексы
   - Координаты GPS

3. КОРПОРАТИВНАЯ ИНФОРМАЦИЯ:
   - Названия компаний и организаций
   - Названия департаментов и подразделений
   - Виды деятельности и тип компании ( например, нефтедобыча, Нефтедобывающая Компания, создание ПО, Интегратор ИТ, поставка серверов,и тп)
   - Номера договоров и соглашений
   - Коды проектов
   - Внутренние системы и сервисы
   - Корпоративные домены и URL
   - Логины и пароли
   - API ключи и токены

4. ТЕХНИЧЕСКАЯ ИНФОРМАЦИЯ:
   - Марки и модели оборудования
   - Серийные номера
   - Версии программного обеспечения
   - Названия серверов и баз данных
   - Сетевые настройки и конфигурации
   - Технические характеристики

5. ФИНАНСОВАЯ ИНФОРМАЦИЯ:
   - Суммы сделок и контрактов
   - Бюджеты проектов
   - Зарплаты и компенсации
   - Номера счетов и карт
   - Финансовые показатели

6. ВРЕМЕННЫЕ ДАННЫЕ:
   - Конкретные даты событий
   - Временные периоды проектов
   - Дедлайны и сроки

ФОРМАТ ОТВЕТА:

Представь результат в следующем формате:

## КАРТА ЗАМЕН ЧУВСТВИТЕЛЬНЫХ ДАННЫХ

### ПЕРСОНАЛЬНЫЕ ДАННЫЕ
| Исходное значение | Категория | Замена | Обоснование |
|-------------------|-----------|--------|-------------|
| [найденная сущность] | [тип данных] | [анонимизированная замена] | [почему это чувствительно] |

### КОРПОРАТИВНАЯ ИНФОРМАЦИЯ
| Исходное значение | Категория | Замена | Обоснование |
|-------------------|-----------|--------|-------------|

### ТЕХНИЧЕСКАЯ ИНФОРМАЦИЯ
| Исходное значение | Категория | Замена | Обоснование |
|-------------------|-----------|--------|-------------|

### ГЕОГРАФИЧЕСКИЕ ДАННЫЕ
| Исходное значение | Категория | Замена | Обоснование |
|-------------------|-----------|--------|-------------|

### ФИНАНСОВАЯ ИНФОРМАЦИЯ
| Исходное значение | Категория | Замена | Обоснование |
|-------------------|-----------|--------|-------------|



ОСОБЫЕ ТРЕБОВАНИЯ:
- В ананимизированной замене не должно быть никакой информации о виде деятельности, типе компании, другая информация, по которой можно восстановить чувствительную информацию( например: Недопустимо- Нефтегазовая_Компания_1, Допустимо: Добывающая_Компания_1)
- Выяви скрытые паттерны (например, номера телефонов без явного указания)
- Определи косвенные идентификаторы
- Учти контекстуальную чувствительность
- Предложи градацию анонимизации (частичная/полная)

Текст встречи:

{text}
"""


    payload = {
        "model": model_name,
        "prompt": prompt,
        "stream": False,
        "options": {
            "temperature": 0.5,
            "num_predict": 3000,
            "num_ctx": count_tokens(prompt) + 1000,
        },
        "think": False
    }

    try:
        print("\n\n=====STARTING MAPPING GENERATION======\n")
        response = requests.post(f"{OLLAMA_URL}/api/generate", json=payload)
        response.raise_for_status()

        response_text = response.json().get("response", "").strip()

        if not response_text:
            return "[ERROR]: Empty response from model."
        
        print("\n======MAPPING GENERATION RESPONSE======\n")
        print(response_text)
        print("\n\n\n")

        print("MAPPING SAVING IN PROGRESS....\n")
        safe_model = re.sub(r'[^\w.-]+', '_', model_name)
        filename = f"tests/anonymizer_tests/qwen/{safe_model}_mappings.txt"
        with open(filename, "w+", encoding="utf-8", newline="") as file:
         file.write(f"МОДЕЛЬ: {model_name}\n\n")
         file.write("ОТВЕТ:\n")
         file.write(response_text)
         file.write("\n")


        print("\n!DONE SAVING MAPPINGS!\n")
        return text
    except Exception as e:
        return f"[ERROR]: {e}"

def anonymize_transcript(text: str, mappings: str, model_name: str = "qwen3:30b"):
    prompt = f"""ЗАДАЧА: Анонимизация и очистка транскрипта записи встречи

ВХОДНЫЕ ДАННЫЕ:
1. Исходный транскрипт встречи
2. Карта замен чувствительной информации

ИНСТРУКЦИИ ПО АНОНИМИЗАЦИИ:

1. ПРИМЕНЕНИЕ КАРТЫ ЗАМЕН:
   - Точно следуй предоставленной карте замен
   - Замени ВСЕ вхождения чувствительных данных на указанные анонимизированные значения
   - Обеспечь консистентность: одна сущность = одна замена во всем тексте
   - Сохрани контекст и смысл высказываний
   - При неоднозначности используй наиболее безопасный вариант замены

2. ОБРАБОТКА УЧАСТНИКОВ:
   - Замени имена участников на роли: УЧАСТНИК_А, УЧАСТНИК_Б, МОДЕРАТОР, ЭКСПЕРТ_1
   - Сохрани структуру диалога с указанием ролей
   - Если роль неизвестна, используй УЧАСТНИК_[номер]

ИНСТРУКЦИИ ПО ОЧИСТКЕ ТРАНСКРИПТА:

3. УДАЛЕНИЕ ШУМОВОЙ ИНФОРМАЦИИ:
   - Убери междометья: "хм", "ээ", "ааа", "угу", "да-да", "вот"
   - Удали повторы слов: "это это это важно" → "это важно"
   - Убери слова-паразиты: "типа", "короче", "в общем-то", "как бы"
   - Удали незавершенные фразы и обрывки мыслей
   - Убери технические комментарии о связи: "меня слышно?", "звук пропал"

4. ИСПРАВЛЕНИЕ ОШИБОК ТРАНСКРИБАЦИИ:
   - Исправь очевидные ошибки распознавания речи по контексту
   - Восстанови сокращения до полных слов где необходимо
   - Исправь неправильно расставленные знаки препинания
   - Устрани логические несоответствия в тексте

5. СОКРАЩЕНИЕ МНОГОСЛОВНОСТИ:
   - Сократи избыточные формулировки до сути
   - "Я хотел бы сказать, что возможно нам стоит рассмотреть" → "Предлагаю рассмотреть"
   - "В принципе, наверное, можно было бы попробовать" → "Можно попробовать"
   - Убери лишние вводные конструкции
   - Сохрани ключевые решения и выводы

6. СТРУКТУРИРОВАНИЕ ТЕКСТА:
   - Разбей на логические блоки по темам
   - Добавь временные метки для ключевых моментов
   - Выдели принятые решения и действия
   - Сохрани важные вопросы и ответы

ФОРМАТ ВЫВОДА:

## АНОНИМИЗИРОВАННЫЙ И ОЧИЩЕННЫЙ ТРАНСКРИПТ

### УЧАСТНИКИ ВСТРЕЧИ:
- УЧАСТНИК_А: [роль/должность в анонимизированном виде]
- УЧАСТНИК_Б: [роль/должность в анонимизированном виде]
- МОДЕРАТОР: [роль/должность в анонимизированном виде]

### ОСНОВНОЕ СОДЕРЖАНИЕ:

**[ЧЧ:ММ] Тема/блок обсуждения**

УЧАСТНИК_А: [очищенная и анонимизированная речь]

УЧАСТНИК_Б: [очищенная и анонимизированная речь]

### КЛЮЧЕВЫЕ РЕШЕНИЯ:
1. [Решение 1 в анонимизированном виде]
2. [Решение 2 в анонимизированном виде]

### ДЕЙСТВИЯ И ОТВЕТСТВЕННЫЕ:
| Действие | Ответственный | Срок |
|----------|---------------|------|
| [анонимизированное действие] | [анонимизированная роль] | [период] |

### ОТКРЫТЫЕ ВОПРОСЫ:
1. [Вопрос 1 в анонимизированном виде]
2. [Вопрос 2 в анонимизированном виде]

## СТАТИСТИКА ОБРАБОТКИ:
- Исходная длина: [количество слов/символов]
- Финальная длина: [количество слов/символов]
- Степень сжатия: [процент]
- Количество замен: [число]
- Удаленных шумовых элементов: [число]

ПРИНЦИПЫ ОБРАБОТКИ:

1. СОХРАНЕНИЕ СМЫСЛА:
   - Не искажай фактическую информацию
   - Сохрани логику обсуждения
   - Поддержи причинно-следственные связи
   - Оставь ключевые аргументы

2. БЕЗОПАСНОСТЬ ДАННЫХ:
   - Приоритет безопасности над детализацией
   - При сомнениях выбирай более анонимную замену
   - Не допускай возможности обратной идентификации
   - Проверь отсутствие косвенных идентификаторов

3. ЧИТАЕМОСТЬ РЕЗУЛЬТАТА:
   - Обеспечь связность текста
   - Сохрани естественность речи
   - Поддержи профессиональный тон
   - Убедись в понятности контекста

СПЕЦИАЛЬНЫЕ ТРЕБОВАНИЯ:

4. ОБРАБОТКА ТЕХНИЧЕСКИХ ТЕРМИНОВ:
   - Сохрани профессиональную терминологию
   - Анонимизируй только специфичные названия
   - Оставь общепринятые стандарты и методологии

5. ВРЕМЕННЫЕ ДАННЫЕ:
   - Замени конкретные даты на периоды: "15 марта" → "в середине месяца"
   - Сохрани относительные временные указания
   - Обобщи сроки проектов

ВХОДНЫЕ ДАННЫЕ ДЛЯ ОБРАБОТКИ:

КАРТА ЗАМЕН:

### ПЕРСОНАЛЬНЫЕ ДАННЫЕ

| Исходное значение | Категория | Замена | Обоснование |
|-------------------|-----------|--------|-------------|
| Артем | Имя | Артем_1 | Имя участника встречи, может быть использовано для идентификации |
| Оксана Соренкова | ФИО | Сотрудник_2 | Персональные данные сотрудника компании |
| Астра | Имя | Астра_1 | Имя сотрудника, потенциально может быть использовано для идентификации |
| Тимофей | Имя | Сотрудник_3 | Участник тестирования, может быть использовано для идентификации |
| Жариков | Имя | Сотрудник_4 | Имя сотрудника другой компании |
| Доброцен | Имя | Сотрудник_5 | Имя сотрудника, участвующего в проекте |
| Лена | Имя | Сотрудник_6 | Имя сотрудника, участвующего в проекте |
| Макс | Имя | Сотрудник_7 | Имя сотрудника, участвующего в проекте |
| Оля | Имя | Сотрудник_8 | Имя сотрудника, участвующего в проекте |
| Яков | Имя | Сотрудник_9 | Имя сотрудника, участвующего в проекте |

---

### КОРПОРАТИВНАЯ ИНФОРМАЦИЯ

| Исходное значение | Категория | Замена | Обоснование |
|-------------------|-----------|--------|-------------|
| Объединенные Институты Ядерных Исследований | Название организации | Организация_1 | Научная организация, может быть использована для идентификации |
| МТС-линк | Название продукта/сервиса | Сервис_1 | Продукт, может быть использован для идентификации |
| RConf | Название продукта/сервиса | Сервис_2 | Продукт, может быть использован для идентификации |
| Rostec | Название организации | Организация_2 | Корпоративная организация |
| МТС | Название организации | Организация_3 | Корпоративная организация |
| Пантер | Название организации | Организация_4 | Корпоративная организация |
| SoftLine | Название организации | Организация_5 | Корпоративная организация |
| Норникель | Название организации | Организация_6 | Корпоративная организация |
| Доброцен | Имя продукта | Продукт_1 | Имя продукта, может быть использовано для идентификации |
| IRNL | Название продукта | Продукт_2 | Имя продукта, может быть использовано для идентификации |
| Rostec | Название организации | Организация_2 | Корпоративная организация |
| МТС | Название организации | Организация_3 | Корпоративная организация |
| Пантер | Название организации | Организация_4 | Корпоративная организация |
| SoftLine | Название организации | Организация_5 | Корпоративная организация |
| Норникель | Название организации | Организация_6 | Корпоративная организация |
| МТС-линк | Название продукта/сервиса | Сервис_1 | Продукт, может быть использован для идентификации |
| RConf | Название продукта/сервиса | Сервис_2 | Продукт, может быть использован для идентификации |
| Rostec | Название организации | Организация_2 | Корпоративная организация |
| МТС | Название организации | Организация_3 | Корпоративная организация |
| Пантер | Название организации | Организация_4 | Корпоративная организация |
| SoftLine | Название организации | Организация_5 | Корпоративная организация |
| Норникель | Название организации | Организация_6 | Корпоративная организация |
| Доброцен | Имя продукта | Продукт_1 | Имя продукта, может быть использовано для идентификации |
| IRNL | Название продукта | Продукт_2 | Имя продукта, может быть использовано для идентификации |
| МТС-линк | Название продукта/сервиса | Сервис_1 | Продукт, может быть использован для идентификации |
| RConf | Название продукта/сервиса | Сервис_2 | Продукт, может быть использован для идентификации |
| Rostec | Название организации | Организация_2 | Корпоративная организация |
| МТС | Название организации | Организация_3 | Корпоративная организация |
| Пантер | Название организации | Организация_4 | Корпоративная организация |
| SoftLine | Название организации | Организация_5 | Корпоративная организация |
| Норникель | Название организации | Организация_6 | Корпоративная организация |
| Доброцен | Имя продукта | Продукт_1 | Имя продукта, может быть использовано для идентификации |
| IRNL | Название продукта | Продукт_2 | Имя продукта, может быть использовано для идентификации |

---

### ГЕОГРАФИЧЕСКИЕ ДАННЫЕ

| Исходное значение | Категория | Замена | Обоснование |
|-------------------|-----------|--------|-------------|
| Норникель | Название организации | Организация_6 | Может быть использовано для идентификации региона |

---

### ФИНАНСОВАЯ ИНФОРМАЦИЯ

| Исходное значение | Категория | Замена | Обоснование |
|-------------------|-----------|--------|-------------|
| 340 тысяч | Сумма | Сумма_1 | Финансовая информация, может быть использована для идентификации |

---

### КОНТАКТНАЯ ИНФОРМАЦИЯ (ПОТЕНЦИАЛЬНО)

| Исходное значение | Категория | Замена | Обоснование |
|-------------------|-----------|--------|-------------|
| (не указано) | Имейл / Телефон | Информация_1 | Потенциальная контактная информация, не указана полностью, но может быть восстановлена |

---

### СЕРВИСЫ И ПРОТОКОЛЫ

| Исходное значение | Категория | Замена | Обоснование |
|-------------------|-----------|--------|-------------|
| Telegram | Сервис | Сервис_3 | Сервис общения, может быть использован для идентификации |
| ВИСБОМ | Сервис | Сервис_4 | Сервис общения, может быть использован для идентификации |
| Телеграм | Сервис | Сервис_3 | Сервис общения, может быть использован для идентификации |
| ВИСБОМ | Сервис | Сервис_4 | Сервис общения, может быть использован для идентификации |

---

### ПРОЕКТЫ И ЗАДАЧИ

| Исходное значение | Категория | Замена | Обоснование |
|-------------------|-----------|--------|-------------|
| Асессмент региональных директоров | Проект | Проект_1 | Может быть использован для идентификации |

---

### ТЕХНОЛОГИИ И ПРОДУКТЫ

| Исходное значение | Категория | Замена | Обоснование |
|-------------------|-----------|--------|-------------|
| Клод | Название продукта | Продукт_3 | Имя продукта, может быть использовано для идентификации |
| GPT | Название продукта | Продукт_4 | Имя продукта, может быть использовано для идентификации |
| ChatGPT | Название продукта | Продукт_5 | Имя продукта, может быть использовано для идентификации |
| FAS | Название продукта | Продукт_6 | Имя продукта, может быть использовано для идентификации |
| M2C | Название продукта | Продукт_7 | Имя продукта, может быть использовано для идентификации |
| DFD | Название продукта | Продукт_8 | Имя продукта, может быть использовано для идентификации |
| SAS | Название продукта | Продукт_9 | Имя продукта, может быть использовано для идентификации |
| IRNL | Название продукта | Продукт_2 | Имя продукта, может быть использовано для идентификации |
| Клод | Название продукта | Продукт_3 | Имя продукта, может быть использовано для идентификации |
| GPT | Название продукта | Продукт_4 | Имя продукта, может быть использовано для идентификации |
| ChatGPT | Название продукта | Продукт_5 | Имя продукта, может быть использовано для идентификации |
| FAS | Название продукта | Продукт_6 | Имя продукта, может быть использовано для идентификации |
| M2C | Название продукта | Продукт_7 | Имя продукта, может быть использовано для идентификации |
| DFD | Название продукта | Продукт_8 | Имя продукта, может быть использовано для идентификации |
| SAS | Название продукта | Продукт_9 | Имя продукта, может быть использовано для идентификации |

---

### ДОПОЛНИТЕЛЬНЫЕ ЗАМЕЧАНИЯ

- **Встречи и сроки**:
  - 19 и 20 декабря – проведение асессмента.
  - 20 декабря – завершение асессмента.
  - 31 декабря – ожидаемая дата составления отчета.

- **Серверы**:
  - Упоминание российских серверов, что может быть потенциально чувствительной информацией.

- **Юридические аспекты**:
  - Упоминание ФАС, что может быть связано с возможной жалобой и использованием в корпоративных целях.

---

ИСХОДНЫЙ ТРАНСКРИПТ:
{text}
```

## Дополнительные правила обработки:

### Типовые шаблоны очистки:

**Убрать:**
- "Так, ээээ, значит..."
- "Ну как бы это сказать..."
- "В общем и целом получается что..."
- "Если я правильно понимаю..."
- "Давайте все-таки попробуем..."

**Заменить на:**
- Прямые формулировки
- Четкие утверждения
- Конкретные предложения

### Примеры обработки:

**До:**
"Иванов П.С.: Ээээ, ну вот, в общем-то, я хотел бы сказать, что наверное нам стоило бы рассмотреть возможность, хм, закупки серверов Dell R740 для нашего офиса в Москве..."

**После:**
"УЧАСТНИК_А: Предлагаю рассмотреть закупку ОБОРУДОВАНИЕ_1 МОДЕЛЬ_X для офиса в ГОРОДЕ_1."


## КАРТА ЗАМЕН ЧУВСТВИТЕЛЬНЫХ ДАННЫХ

### ПЕРСОНАЛЬНЫЕ ДАННЫЕ
| Исходное значение | Категория | Замена | Обоснование |
|------------------|-----------|---------|-------------|
| Михаил Лиховецкий | ФИО | Сотрудник_А | Персональные данные физического лица |
| Елена Евтеева | ФИО | Сотрудник_Б | Персональные данные физического лица |
| Артем Садыков | ФИО | Сотрудник_В | Персональные данные физического лица |
| Дмитрий Волков | ФИО | Кандидат_1 | Персональные данные физического лица |
| Артем Васильев | ФИО | Кандидат_2 | Персональные данные физического лица |
| Максим Соколов | ФИО | Кандидат_3 | Персональные данные физического лица |
| Иван Иванов | ФИО | Оператор_1 | Персональные данные физического лица |

### КОРПОРАТИВНАЯ ИНФОРМАЦИЯ
| Исходное значение | Категория | Замена | Обоснование |
|------------------|-----------|---------|-------------|
| ComputeCenter | Название компании | Компания_Интегратор_1 | Корпоративная информация |
| Project Volga | Название компании | Компания_Партнер_1 | Корпоративная информация |
| Aircon | Название компании | Компания_Поставщик_1 | Корпоративная информация |
| Газпром | Название компании | Компания_Заказчик_1 | Корпоративная информация |
| Роснефть | Название компании | Компания_Заказчик_2 | Корпоративная информация |
| МТС | Название компании | Компания_Телеком_1 | Корпоративная информация |
| системный интегратор | Тип деятельности | Поставщик_Услуг_1 | Информация о виде деятельности |
| обслуживание точек бурения, нефти и добычи газа | Вид деятельности | Обслуживание_Промышленных_Объектов | Информация о специализации |
| контакт-центр | Подразделение | Служба_Поддержки_1 | Корпоративная структура |
| IT-служба | Подразделение | Техническое_Подразделение_1 | Корпоративная структура |

### ТЕХНИЧЕСКАЯ ИНФОРМАЦИЯ
| Исходное значение | Категория | Замена | Обоснование |
|------------------|-----------|---------|-------------|
| речевая аналитика | Технология | Система_Анализа_1 | Техническая информация |
| искусственный интеллект | Технология | ИИ_Система | Техническая информация |
| API | Технический интерфейс | Программный_Интерфейс | Техническая информация |
| видеоконференц связи | Технология | Система_Связи_1 | Техническая информация |
| диаризация | Технический процесс | Процесс_Разделения_Речи | Техническая информация |
| транскрибация | Технический процесс | Преобразование_Речи | Техническая информация |
| промты | Технический термин | Команды_Системы | Техническая информация |
| LLM | Технология | Языковая_Модель | Техническая информация |
| Json | Формат данных | Формат_Обмена_Данных | Техническая информация |

### ГЕОГРАФИЧЕСКИЕ ДАННЫЕ
| Исходное значение | Категория | Замена | Обоснование |
|------------------|-----------|---------|-------------|
| за уралом | Географическое расположение | Удаленный_Регион_1 | Географическая информация |
| за полярем | Географическое расположение | Удаленный_Регион_2 | Географическая информация |

### ФИНАНСОВАЯ ИНФОРМАЦИЯ
| Исходное значение | Категория | Замена | Обоснование |
|------------------|-----------|---------|-------------|
| 2,5 рубля за минуту | Тарифная ставка | Тариф_За_Единицу | Коммерческая информация |
| 750 часов | Объем услуг | Объем_Обработки_Месяц | Коммерческие показатели |

### ВРЕМЕННЫЕ ДАННЫЕ
| Исходное значение | Категория | Замена | Обоснование |
|------------------|-----------|---------|-------------|
| до конца месяца | Временные рамки | Плановый_Период_1 | Временная информация проекта |
| один месяц | Период внедрения | Период_Реализации | Временные характеристики |
| две недели | Тестовый период | Пилотный_Период | Временные рамки тестирования |

### ДОПОЛНИТЕЛЬНЫЕ ЧУВСТВИТЕЛЬНЫЕ ДАННЫЕ
| Исходное значение | Категория | Замена | Обоснование |
|------------------|-----------|---------|-------------|
| конверсия с четырех до четырнадцать процентов | Бизнес-метрики | Улучшение_Показателей_X% | Коммерческие результаты |
| три с половиной раза | Коэффициент улучшения | Кратное_Улучшение | Коммерческая эффективность |
| iOS разработчик | Специализация | Разработчик_Мобильных_Приложений | Профессиональная информация |
| Swift | Технология программирования | Язык_Программирования_1 | Техническая специализация |"""
    
    payload = {
        "model": model_name,
        "prompt": prompt,
        "stream": False,
        "options": {
            "temperature": 0.5,
            "num_predict": 10000,
            "num_ctx": count_tokens(prompt) + 10000,
        },
        "think": False
    }

    try:
        print("=====STARTING TRANSCRIPT ANONYMIZATION=====")
        response = requests.post(f"{OLLAMA_URL}/api/generate", json=payload)
        response.raise_for_status()

        text = response.json().get("response", "").strip()

        if not text:
            return "[ERROR]: Empty response from model."
        
        print("\n======TRANSCRIPT ANONYMIZATION RESPONSE======\n")
        print(text)
        print("\n\n\n")
        
        print("ANON TRANSCRIPT SAVING IN PROGRESS....\n")
        safe_model = re.sub(r'[^\w.-]+', '_', model_name)
        filename = f"tests/anonymizer_tests/qwen/{safe_model}_anontranscript.txt"
        with open(filename, "w+", encoding="utf-8", newline="") as file:
         file.write(f"МОДЕЛЬ: {model_name}\n\n")
         file.write("ОТВЕТ:\n")
         file.write(text)
         file.write("\n")

        print("!DONE!")
        return text
    except Exception as e:
        return f"[ERROR]: {e}"

if __name__ == "__main__":
   option = int(input("Choose file option:\n 1. Командос17-12.txt \t 2. Командос23-12.txt\n"))
   if option == 2:
      filepath = "transcripts/Командос23-12.txt"
   elif option == 1:
      filepath = "transcripts/Командос17-12.txt"

   print(f"\nФАЙЛ ВЫБРАН: {filepath}\n")
   with open(f"{filepath}", "r", encoding="utf-8") as file:
      orginal_text = file.read()

   mapping_model_name = input("\nВведите название модели для карты замен:\n").strip()

   print("\n============Starting anonymization pipeline============\n")
   anon_mapping = get_anonymization_mapping(orginal_text, mapping_model_name)

   anon_model_name = input("\nВведите название модели для анонимизации:\n").strip()
   anonymize_transcript(orginal_text, "", model_name=anon_model_name)
    